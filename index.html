<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hycross AI Chat with Open Router</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
  <style>
    /* Optional: Customize scrollbar for chat area */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(100, 100, 100, 0.5);
      border-radius: 4px;
    }
    .code-block {
      position: relative;
      margin-top: 10px;
    }
    pre {
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin: 0;
      overflow-x: auto;
    }
    code {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
    }
    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 5px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-300">
  <!-- Main Container -->
  <div class="min-h-screen flex flex-col items-center">
    <!-- Setup Section -->
    <div id="setupSection" class="p-4 flex flex-col space-y-4 w-full max-w-md">
      <div class="flex flex-col space-y-2">
        <label for="apiKey" class="font-semibold">Open Router API Key:</label>
        <input type="text" id="apiKey" placeholder="Enter your Open Router API key" class="p-2 border border-gray-300 rounded-md">
        <button onclick="saveApiKey()" class="p-2 bg-violet-500 text-white rounded-md">Save API Key</button>
      </div>
      <div class="flex flex-col space-y-2">
        <label for="modelSelect" class="font-semibold">Select Model:</label>
        <select id="modelSelect" onchange="handleModelChange()" class="p-2 border border-gray-300 rounded-md">
          <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo (openai/gpt-3.5-turbo)</option>
          <option value="openai/gpt-4">GPT-4 (openai/gpt-4)</option>
          <option value="anthropic/claude-2">Claude 2 (anthropic/claude-2)</option>
          <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (anthropic/claude-3.5-sonnet)</option>
          <option value="anthropic/claude-3-haiku">Claude 3 Haiku (anthropic/claude-3-haiku)</option>
          <option value="meta-llama/llama-2-70b-chat">Llama 2 70B Chat (meta-llama/llama-2-70b-chat)</option>
          <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B Instruct (meta-llama/llama-3.3-70b-instruct)</option>
          <option value="deepseek/deepseek-r1">DeepSeek R1 (deepseek/deepseek-r1)</option>
          <option value="deepseek/deepseek-r1:free">DeepSeek R1 (free) (deepseek/deepseek-r1:free)</option>
          <option value="mistral/mistral-7b-instruct">Mistral 7B Instruct (mistral/mistral-7b-instruct)</option>
          <option value="mistral/mistral-7b-instruct:free">Mistral 7B Instruct (free) (mistral/mistral-7b-instruct:free)</option>
          <option value="mistral/mistral-large">Mistral Large (mistral/mistral-large)</option>
          <option value="google/gemma-2-9b-it">Gemma 2 9B (google/gemma-2-9b-it)</option>
          <option value="google/gemma-2-9b-it:free">Gemma 2 9B (free) (google/gemma-2-9b-it:free)</option>
          <option value="google/gemma-2-27b-it">Gemma 2 27B (google/gemma-2-27b-it)</option>
          <option value="qwen/qwen-2.5-72b-instruct">Qwen2.5 72B Instruct (qwen/qwen-2.5-72b-instruct)</option>
          <option value="other">Other (Enter custom model ID)</option>
        </select>
        <input type="text" id="customModel" placeholder="Enter custom model ID" class="p-2 border border-gray-300 rounded-md hidden">
      </div>
      <button id="startChatButton" onclick="startChat()" class="p-2 bg-green-500 text-white rounded-md" disabled>Start Chat</button>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="hidden w-full max-w-3xl flex flex-col">
      <!-- Header -->
      <header class="bg-white shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <img src="https://via.placeholder.com/40" alt="Logo" class="rounded-full shadow-lg p-1" />
          <h1 class="text-2xl font-bold">Hycross AI Chat</h1>
        </div>
      </header>

      <!-- Chat Area -->
      <main id="chatArea" class="flex-grow p-4 overflow-y-auto space-y-4">
        <!-- Sample incoming message -->
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-blue-500 rounded-full flex-shrink-0"></div>
          <div class="bg-white p-3 rounded-lg shadow max-w-md">
            <p>Hello! How can I assist you today?</p>
          </div>
        </div>
      </main>

      <!-- Chat Input Area -->
      <footer class="p-4">
        <div class="mx-auto max-w-3xl">
          <div class="flex items-center space-x-2">
            <input
              id="messageInput"
              type="text"
              placeholder="Type your message here..."
              class="flex-grow bg-white border border-gray-300 rounded-full pl-6 py-4 text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-violet-500 transition"
            />
            <button
              id="sendButton"
              class="w-14 h-14 rounded-full bg-violet-500 group shadow-xl flex items-center justify-center relative overflow-hidden"
            >
              <svg class="relative z-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 64 64" width="28" height="28">
                <path fill-opacity="0.01" fill="white" d="M63.6689 29.0491L34.6198 63.6685L0.00043872 34.6194L29.0496 0L63.6689 29.0491Z"></path>
                <path stroke-linejoin="round" stroke-linecap="round" stroke-width="3.77" stroke="white" d="M42.85 18.71L21.06 44.67"></path>
                <path stroke-linejoin="round" stroke-linecap="round" stroke-width="3.77" stroke="white" d="M26.93 20.1L42.85 18.71L44.24 34.62"></path>
              </svg>
              <div class="w-full h-full rotate-45 absolute left-[32%] top-[32%] bg-black group-hover:-left-[100%] group-hover:-top-[100%] transition-all duration-500"></div>
              <div class="w-full h-full -rotate-45 absolute -left-[32%] -top-[32%] bg-black group-hover:left-[100%] group-hover:top-[100%] transition-all duration-500"></div>
            </button>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script>
    let apiKey = '';
    let conversationHistory = [];
    let selectedModel = 'openai/gpt-3.5-turbo';
    let isSending = false;

    function saveApiKey() {
      apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) {
        alert('Please enter a valid API key.');
        return;
      }
      alert('API key saved successfully.');
      document.getElementById('startChatButton').disabled = false;
    }

    function handleModelChange() {
      const modelSelect = document.getElementById('modelSelect').value;
      const customModelInput = document.getElementById('customModel');
      if (modelSelect === 'other') {
        customModelInput.classList.remove('hidden');
        selectedModel = customModelInput.value.trim() || 'openai/gpt-3.5-turbo';
      } else {
        customModelInput.classList.add('hidden');
        selectedModel = modelSelect;
      }
      customModelInput.addEventListener('input', () => {
        selectedModel = customModelInput.value.trim() || 'openai/gpt-3.5-turbo';
      });
    }

    function startChat() {
      if (!apiKey) {
        alert('Please enter and save your API key first.');
        return;
      }
      document.getElementById('setupSection').classList.add('hidden');
      document.getElementById('chatSection').classList.remove('hidden');
    }

    // Helper to format code blocks correctly
    function formatCodeBlocks(text) {
      return text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        return `<div class="code-block"><pre><code class="language-${lang || 'plaintext'}">${code}</code></pre><button class="copy-button" onclick="copyCode(this)">Copy</button></div>`;
      });
    }

    function addMessage(content, isUser) {
      const chatArea = document.getElementById('chatArea');
      const messageBubble = document.createElement('div');
      messageBubble.className = isUser ? 'flex justify-end' : 'flex items-start space-x-3';

      if (isUser) {
        messageBubble.innerHTML = `
          <div class="bg-violet-500 text-white p-3 rounded-lg shadow max-w-md break-words">
            ${content}
          </div>
        `;
      } else {
        messageBubble.innerHTML = `
          <div class="w-10 h-10 bg-blue-500 rounded-full flex-shrink-0"></div>
          <div class="bg-white p-3 rounded-lg shadow max-w-md">
            <p>${formatCodeBlocks(content)}</p>
          </div>
        `;
        Prism.highlightAllUnder(messageBubble);
      }

      chatArea.appendChild(messageBubble);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function copyCode(button) {
      const code = button.previousElementSibling.querySelector('code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert('Code copied to clipboard!');
      });
    }

    async function sendMessage() {
      if (isSending) return;
      isSending = true;

      const userInput = document.getElementById('messageInput').value.trim();
      if (!userInput) {
        isSending = false;
        return;
      }

      addMessage(userInput, true);
      conversationHistory.push({ role: 'user', content: userInput });
      document.getElementById('messageInput').value = '';

      const messages = conversationHistory.map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      try {
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'HTTP-Referer': window.location.href,
            'X-Title': 'Hycross AI Chat with Open Router'
          },
          body: JSON.stringify({
            model: selectedModel,
            messages: messages,
            stream: true
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';
        let messageDiv = null;

        const timeoutId = setTimeout(() => {
          reader.cancel();
          alert('Response taking too long. Please try a different model or check your API key.');
          isSending = false;
        }, 15000); // 15-second timeout

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n').filter(line => line.trim());

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6).trim();
              if (data === '[DONE]') {
                clearTimeout(timeoutId);
                isSending = false;
                break;
              }

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices[0]?.delta?.content;
                if (content) {
                  assistantMessage += content;
                  if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.className = 'flex items-start space-x-3';
                    messageDiv.innerHTML = `
                      <div class="w-10 h-10 bg-blue-500 rounded-full flex-shrink-0"></div>
                      <div class="bg-white p-3 rounded-lg shadow max-w-md">
                        <p>${formatCodeBlocks(assistantMessage)}</p>
                      </div>
                    `;
                    document.getElementById('chatArea').appendChild(messageDiv);
                    Prism.highlightAllUnder(messageDiv);
                  } else {
                    messageDiv.querySelector('p').innerHTML = formatCodeBlocks(assistantMessage);
                    Prism.highlightAllUnder(messageDiv);
                  }
                  document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
                }
              } catch (e) {
                console.error('Error parsing stream data:', e);
              }
            }
          }
        }

        if (assistantMessage) {
          conversationHistory.push({ role: 'assistant', content: assistantMessage });
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please check your API key, model selection, or try again later.');
        isSending = false;
      }
    }

    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    const sendButton = document.getElementById('sendButton');
    sendButton.addEventListener('click', sendMessage);
  </script>
</body>
</html>
